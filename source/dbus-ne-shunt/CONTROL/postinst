#!/bin/sh

VE_SERVICE_NAME="neshunt"

SERVICE_NAME="dbus-ne-shunt"
DBUS_NE_SHUNT_INSTALL_PATH="/opt/victronenergy/${SERVICE_NAME}"

USB_PYTHON_SCRIPT_FILE=PYTHONSCRIPT="${DBUS_NE_SHUNT_INSTALL_PATH}/usb-serial-helper.py"
USB_SERIAL_HELPER_ACTION="add" #"detect+add" "add" "remove" 
SERIAL_STARTER_RULES_FILE="/etc/udev/rules.d/serial-starter.rules"
DBUS_MESSAGE_PATH="com.victronenergy.packageManager /GuiEditStatus"
DBUS_MESSAGE_PATH=""

python "${USB_PYTHON_SCRIPT_FILE}"\
    "${USB_SERIAL_HELPER_ACTION}"\
    "${SERIAL_STARTER_RULES_FILE}"\
    "${VE_SERVICE_NAME}"\
    "${DBUS_MESSAGE_PATH}"

# Declare service in serial starter conf file
SERIAL_STARTER_CONFIG_FILE='/etc/venus/serial-starter.conf'
CONFIG="service ${VE_SERVICE_NAME}       ${SERVICE_NAME}"

if ! grep -q "^${CONFIG}$" "${SERIAL_STARTER_CONFIG_FILE}"; then
  echo "${CONFIG}" >> $SERIAL_STARTER_CONFIG_FILE
fi
 
echo "dbus-ne-shunt installed"